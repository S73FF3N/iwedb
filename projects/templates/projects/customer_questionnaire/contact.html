{% extends "projects/customer_questionnaire/questionnaire_base.html" %}
{% load static %}
{% load i18n %}
{% load widget_tweaks %}

{% block language %}
<form action="{% url 'set_language' %}" method="post" class="language-select">
    {% csrf_token %}
    <input name="next" type="hidden" value="{{ request.get_full_path|slice:'3:' }}" />
    <ul>
        {% get_current_language as LANGUAGE_CODE %}
        {% get_available_languages as LANGUAGES %}
        {% get_language_info_list for LANGUAGES as languages %}
        {% for language in languages %}
            <li>
                <button type="submit" name="language" value="{{ language.code }}" class="{% if language.code == LANGUAGE_CODE %}selected{% endif %} language-button">
                    {{ language.name_local }}
                </button>
            </li>
        {% endfor %}
    </ul>
</form>
{% endblock %}

{% block form %}
    <h2 class="text-headline">{% trans "Personal Data" %}</h2>
    <span>
      <label for="bank_institute" class="text-small-uppercase">{% trans "Company" %} </label>
      {% render_field form.contact_company class="text-body input-select" %}
      <p class="help-text">{{ form.contact_company.help_text }}</p>
    </span>
    <span>
      <label for="iban" class="text-small-uppercase">{% trans "Name" %}</label>
      {% render_field form.contact_name class="text-body" %}
      <p class="help-text">{{ form.contact_name.help_text }}</p>
    </span>
    <span>
      <label for="bic" class="text-small-uppercase">Position</label>
      {% render_field form.contact_position class="text-body" %}
      <p class="help-text">{{ form.contact_position.help_text }}</p>
    </span>
    <span>
      <label for="bic" class="text-small-uppercase">Mail</label>
      {% render_field form.contact_mail class="text-body" %}
      <p class="help-text">{{ form.contact_mail.help_text }}</p>
    </span>
    <div class="row">
        <div class="col-lg-1">
            {% render_field form.confirm_data_security class="text-body" %}
        </div>
        <div class="col-lg-11">
            <p class="help-text"></p>
            <p class="help-text">{% trans "You agree that your data will be used to process your request.*" %}</p>
            <p class="help-text">{% trans "Further information and revocation notices can be found in our" %} <a href="https://www.deutsche-windtechnik.com/data-privacy">{% trans "Privacy Policy" %}</a>.</p>
        </div>
    </div>
{% endblock %}

{% block buttons %}
    <div class="row">
        <div class="col-lg-6">
        {% if wizard.steps.prev %}
            <button class="text-small-uppercase" name="wizard_goto_step" type="submit" value="{{ wizard.steps.first }}" formnovalidate>{% trans "first step" %}</button>
            <button class="text-small-uppercase" name="wizard_goto_step" type="submit" value="{{ wizard.steps.prev }}" formnovalidate>{% trans "prev step" %}</button>
        {% endif %}
        </div>
        <div class="text-right col-lg-6">
            <input class="text-small-uppercase" id="submit" type="submit" value="{% trans 'next step' %}">
        </div>
    </div>
    <p></p>
    <p class="help-text-required-field"> * {% trans "indicates a required field" %} </p>
    <h3 class="text-subheadline">{% trans "Step" %} {{ wizard.steps.step1 }} {% trans "of" %} {{ wizard.steps.count }}</h3>
{% endblock %}

{% block javascript %}
var inputs = document.querySelectorAll( 'input[type=text], input[type=email], input[type=number], input[type=select], input[type=tel]' );
for (i = 0; i < inputs.length; i ++) {
  var inputEl = inputs[i];
  if( inputEl.required ){
    var label = inputEl.parentElement.querySelector( 'label' );
    label.innerHTML = label.innerHTML + " * ";
  }
  if( inputEl.value.trim() !== '' ) {
      // adds css class 'inputs--filled'
  	inputEl.parentNode.classList.add( 'inputs--filled' );
  }
  inputEl.addEventListener( 'focus', onFocus );
  inputEl.addEventListener( 'blur', onBlur );
}

var checkbox = document.getElementById("id_contact-confirm_data_security");
checkbox.addEventListener( 'click', handleCheckbox );

function handleCheckbox( ev ) {
  if (checkbox.checked) {
    ev.target.parentNode.classList.remove( 'inputs--invalid' );
  } else {
    ev.target.parentNode.classList.add( 'inputs--invalid' );
  }
}

function onFocus( ev ) {
    ev.target.parentNode.classList.add( 'inputs--filled' );
}

function onBlur( ev ) {
  if ( ev.target.value.trim() === '' ) {
  	ev.target.parentNode.classList.remove( 'inputs--filled' );
  } if ( ev.target.checkValidity() == false ) {
    ev.target.parentNode.classList.add( 'inputs--invalid' );
    ev.target.addEventListener( 'input', liveValidation );
  } else if ( ev.target.checkValidity() == true ) {
    ev.target.parentNode.classList.remove( 'inputs--invalid' );
    ev.target.addEventListener( 'input', liveValidation );
  }
}

function liveValidation( ev ) {
  if ( ev.target.checkValidity() == false ) {
    ev.target.parentNode.classList.add( 'inputs--invalid' );
  } else {
    ev.target.parentNode.classList.remove( 'inputs--invalid' );
  }
}

var submitBtn = document.querySelector( 'input[type=submit]' );
submitBtn.addEventListener( 'click', onSubmit );

function onSubmit( ev ) {
  var inputsWrappers = ev.target.parentNode.querySelectorAll( 'span' );
  for (i = 0; i < inputsWrappers.length; i ++) {
    input = inputsWrappers[i].querySelector( 'input[type=text], input[type=email], input[type=number], input[type=select], input[type=tel], input[type=file]' );
    if ( input.checkValidity() == false ) {
      inputsWrappers[i].classList.add( 'inputs--invalid' );
    } else if ( input.checkValidity() == true ) {
      inputsWrappers[i].classList.remove( 'inputs--invalid' );
    }
    if ( input.type == 'tel' ){
        if( input.value === '' && !input.required){
            inputsWrappers[i].classList.remove( 'inputs--invalid' );
        }else if (!input.value.match(/^\+?1?\d{1,2}[\W\d]+(\d{1,2})$/)){
            inputsWrappers[i].classList.add( 'inputs--invalid' );
            ev.preventDefault();
        }else{
            inputsWrappers[i].classList.remove( 'inputs--invalid' );
        }
    }
  }
  if (checkbox.checked) {
    checkbox.target.parentNode.classList.remove( 'inputs--invalid' );
  } else {
    checkbox.target.parentNode.classList.add( 'inputs--invalid' );
  }
}
{% endblock %}