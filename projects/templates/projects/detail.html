{% extends "polls/base.html" %}
{% load static %}
{% load l10n %}

{% block title %}
    {{ project.name }}
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
    <div class="col-lg-11">
        <h1>{{ project.name }}</h1>
    </div>
    <div class="col-lg-1">
        <a class="btn btn-primary pull-right" href="{% url "projects:project_edit" project.id %}"><i class="fa fa-edit"></i> Edit</a>
    </div>
    </div>
</div>

<div class="container">
    <div class="col-lg-12">
        <table class="table">
            <tr>
                <th colspan="4">General</th>
            </tr>
            {% if project.project_windfarm %}<tr>
                <td>Wind Farm</td>
                <td colspan="3">
                    {% for wf, link in project.project_windfarm.items %}
                    <a href="{{ link }}">{{ wf }}</a>
                    {% endfor %}
                </td>
            </tr>{% endif %}
            <tr>
                <td>Turbines</td>
                <td colspan="3">{{ project.amount_turbines }} / {{ project.mw }} MW / Age <= {{ project.turbine_age }} years</td>
            </tr>
            <tr>
                <td></td>
                <td colspan="3">
                    {% for wec_type, link in project.project_wec_types.items %}
                    <a href="{{ link }}">{{ wec_type }} </a>
                    {% endfor %}
                </td>
            </tr>
            <tr>
                <td></td>
                <td colspan="3">
                    {% for t in project.turbines.all %}
                    <a href="{{ t.get_absolute_url }}">{{ t }} </a>
                    {% endfor %}
                </td>
            </tr>
            <tr>
                <td>DWT Unit</td>
                <td colspan="3">{{ project.dwt }}</td>
            </tr>
            <tr>
                <td>Status</td>
                <td colspan="3">{{ project.status }}</td>
            </tr>
            <tr>
                <td>Probability</td>
                <td colspan="3">{{ project.prob }} %</td>
            </tr>
            <tr>
                <td>Responsible</td>
                <td colspan="3">{{ project.responsible }}</td>
            </tr>
            <tr>
                <td>Request Date</td>
                <td colspan="3">{{ project.request_date }}</td>
            </tr>
            <tr>
                <td>Last Contact</td>
                <td colspan="3">{{ project.last_contact }}</td>
            </tr>
            <tr>
                <th colspan="4">Customer</th>
            </tr>
            {% if project.project_owner|length > 0 %}
            <tr>
                <td>Owner</td>
                <td colspan="3">
                    {% for o, link in project.project_owner.items %}
                    <a href="{{ link }}">{{ o }}</a>
                    {% endfor %}
                </td>
            </tr>
            {% endif %}
            <tr>
                <td>Customer</td>
                <td colspan="3">
                   <a href="{{ project.customer.get_absolute_url }}">{{ project.customer }}</a> / New Customer: {{ project.new_customer }}
                </td>
            </tr>
            <tr>
                <td></td>
                <td colspan="3">
                   {% if customer.adress %}{{ project.customer.adress }}, {{ project.customer.postal_code }} {{ project.customer.city }}, {% endif %}{{ project.customer.country }}
                </td>
            </tr>
            {% if project.customer_contact %}
            <tr>
                <td>Contact Person</td>
                <td colspan="3">
                   {{ project.customer_contact.name }}{% if project.customer_contact.mail %}, {{ project.customer_contact.mail }}{% endif %}{% if project.customer_contact.phone %}, {{ project.customer_contact.phone }}{% endif %}{% if project.customer_contact.phone2 %}, {{ project.customer_contact.phone2 }}{% endif %}
                </td>
            </tr>
            {% endif %}
            <tr>
                <th colspan="4">Contract</th>
            </tr>
            {% if project.department %}
            <tr>
                <td>Department</td>
                <td colspan="3">
                   {{ project.department }}
                </td>
            </tr>
            {% endif %}
            {% if project.contract_type %}
            <tr>
                <td>Contract Type</td>
                <td colspan="3">
                   {{ project.contract_type }}
                </td>
            </tr>
            {% endif %}
            {% if project.start_operation %}
            <tr>
                <td>Start Date</td>
                <td colspan="3">{{ project.start_operation }}</td>
            </tr>
            {% endif %}
            {% if project.run_time %}
            <tr>
                <td>Run Time</td>
                <td colspan="3">
                   {{ project.run_time }} years
                </td>
            </tr>
            {% endif %}
            {% if project.contract_signature %}
            <tr>
                <td>Contract Signature</td>
                <td colspan="3">
                   {{ project.contract_signature }}
                </td>
            </tr>
            {% endif %}
            {% if project.price %}
            <tr>
                <td>Price</td>
                <td colspan="3">
                   {{ project.price }} €/WTG/year
                </td>
            </tr>
            <tr>
                <td>Yearly Contract Value</td>
                <td colspan="3">
                   {{ project.yearly_contract_value }} €/year
                </td>
            </tr>
            {% if project.run_time %}
            <tr>
                <td>Total Contract Value</td>
                <td colspan="3">
                   {{ project.total_contract_value }} €
                </td>
            </tr>
            {% endif %}
            {% endif %}
            {% if project.ebt %}
            <tr>
                <td>EBT</td>
                <td colspan="3">
                   {{ project.ebt }} %
                </td>
            </tr>
            {% endif %}
            <tr>
                <th colspan="4">Closest Service Location</th>
            </tr>
            {% if project.closest_service_location == "coordinates missing" %}
            <tr>
                <td colspan="4">No coordinates provided for turbine(s) and wind farm.</td>
            </tr>
            {% else %}
            <tr>
                <td>Service Location</td>
                <td>{{ project.closest_service_location.name }}</td>
                <td>air-line distance: {{ project.closest_service_location.distance }} km</td>
                <td><a href="https://www.google.de/maps/dir/{{ project.closest_service_location.postal_code }}+{{ project.closest_service_location.name }}/{% if project.turbines.all.0.wind_farm.postal_code %}{{ project.turbines.all.0.wind_farm.postal_code }}+{% endif %}{{ project.turbines.all.0.wind_farm.city }}">Check on Google Maps</a></td>
            </tr>
                <form method=post action="">
                    {% csrf_token %}
                    {% for field in form %}
                    <tr>
                        <td>{{ field.label }}</td>
                        <td>{{ field }}</td>
                        <td>{{ field.errors }}</td>
                    </tr>
                    {% endfor %}
                    <tr>
                        <td colspan="2"><button type="submit" value="Calculate" class="btn btn-primary  pull-left">Calculate</button></td>
                </form>
                        {% if result != None %}
                        <td>Weekday lump sum</td>
                        <td>{{ result }} €</td>
                        {% endif %}
            </tr>
            {% if project.contracts_in_100km_distance %}
            <tr>
                <th>Contracted Windfarms in 100km distance</th>
            </tr>
            <tr>
            {% for c, v in project.contracts_in_100km_distance.items %}
            <tr>
                <td colspan="2"><a href="{{ v.url }}">{{ c }}</a></td>
                <td colspan="2">{{ v.distance }} km</td>
            </tr>
            {% endfor %}
            </tr>
            {% endif %}
            <tr>
            {% endif %}
                <th colspan="4"><a class="btn btn-primary pull-right" href="{% url "projects:new_comment" project_id=project.pk %}"><i class="fa fa-plus"></i> Add Comment</a></th>
            </tr>
            {% if comments.all|length > 0 %}
            <tr>
                <th colspan="4">Comments</th>
            </tr>
            {% for c in comments.all %}
            <tr>
                <td>{{ c.created }} by {{ c.created_by }}</td>
                <td>{{ c.text }}</td>
                {% if c.file %}
                    <td><a href="http://iwedb.tk/media/{{ c.file }}"><i class="fa fa-file pull-right"></a></td>
                    <td><a href="{% url "projects:edit_comment" pk=c.pk project_id=project.pk %}"><i class="fa fa-edit pull-right"></a></td>
                {% else %}
                    <td colspan="2"><a href="{% url "projects:edit_comment" pk=c.pk project_id=project.pk %}"><i class="fa fa-edit pull-right"></a></td>
                {% endif %}
            </tr>
            {% endfor %}
            {% endif %}
            <tr>
                <th colspan="4">Change history</th>
            </tr>
            {% for ch in changes.all %}
            <tr>
                <td>{{ ch.created }} by {{ ch.created_by }}</td>
                <td>{{ ch.text }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
</div>
{% endblock %}