{% extends "polls/base.html" %}
{% load static %}
{% load render_table from django_tables2 %}
{% load widget_tweaks %}

{% block title %}
    Add new Project
{% endblock %}

{% block content %}
{{ form.media }}
<div class="container">
    {% if messages %}
    <ul style="background-color:#ccffb3">
        {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    <form action="" method="post" enctype="multipart/form-data">{% csrf_token %}
       <div class="card">
            <div class="card-header">Add/Edit a project</div>
            <div class="card-body">
                <div class="card">
                    <div class="card-header" id="card-header">
                        General
                        {% if request.resolver_match.view_name == 'projects:new_project' and perms.projects.add_offernumber %}
                            <span>
                            <div class="input-group form-inline form-group-sm pull-right" style="width:20%;">
                                <form id="offer_number_form" method="POST" action="{{ request.path }}" class="form-control">
                                    {% csrf_token %}
                                    {{ offer_number_form.dwt }}
                                </form>
                                <a class="btn btn-primary btn-sm pull-right" href="javascript:void(0)" id="generate_offer_number" onclick="generateOfferNumber();"><i class="fa fa-plus"></i> Generate Offer Number</a>
                            </div>
                            </span>
                        {% endif %}
                    </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="form-group col-lg-6 col-md-6 col-sm-6 col-xs-6">
                                    {{ form.name.label_tag }}<br>
                                    <p class="required">{{ form.name.errors.as_text }}</p>
                                    {% render_field form.name class="form-control" %}
                                    <p class="help-text">{{ form.name.help_text }}</p>
                                </div>
                                <div class="form-group col-lg-2 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.dwt.label_tag }}<br>
                                    <p class="required">{{ form.dwt.errors.as_text }}</p>
                                    {% render_field form.dwt class="form-control" %}
                                    <p class="help-text">{{ form.dwt.help_text }}</p>
                                </div>
                                <div class="form-group col-lg-4 col-md-4 col-sm-6 col-xs-6">
                                {% if request.resolver_match.view_name == 'projects:new_project' or perms.projects.change_sales_manager %}
                                    {{ form.sales_manager.label_tag }}<br>
                                    <p class="required">{{ form.sales_manager.errors.as_text }}</p>
                                    {% render_field form.sales_manager class="form-control" %}
                                    <p class="help-text">{{ form.sales_manager.help_text }}</p>
                                {% else %}
                                    {{ form.sales_manager.as_hidden }}
                                {% endif %}
                                </div>
                                <div class="col-12">
                                    <ul id="similar_projects"></ul>
                                </div>
                                <div class="form-group col-lg-2 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.status.label_tag }}<br>
                                    <p class="required">{{ form.status.errors.as_text }}</p>
                                    {% render_field form.status class="form-control" %}
                                    <p class="help-text">{{ form.status.help_text }}</p>
                                </div>
                                <div class="form-group col-lg-2 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.prob.label_tag }}<br>
                                    <p class="required">{{ form.prob.errors.as_text }}</p>
                                    {% render_field form.prob class="form-control" %}
                                    <p class="help-text">{{ form.prob.help_text }}</p>
                                </div>
                                <div class="form-group col-lg-2 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.tender.label_tag }}<br>
                                    <p class="required">{{ form.tender.errors.as_text }}</p>
                                    {% render_field form.tender class="form-control" %}
                                    <p class="help-text">{{ form.tender.help_text }}</p>
                                </div>
                                <div class="form-group col-lg-4 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.offer_number.label_tag }}<br>
                                    <p class="required">{{ form.offer_number.errors.as_text }}</p>
                                    {% render_field form.offer_number class="form-control" id="offer_number_id" %}
                                    <p class="help-text">{{ form.offer_number.help_text }}</p>
                                </div>
                            </div>
                        </div>
                </div>
                <div class="card">
                    <div class="card-header">Turbines</div>
                        <div class="card-body">
                            <div class="row">
                                {% if request.resolver_match.view_name == 'projects:new_project' %}
                                <div class="form-group col-6">
                                    {{ form.windfarm.label_tag }}<br>
                                    <p class="required">{{ form.windfarm.errors.as_text }}</p>
                                    {% render_field form.windfarm class="form-control" id="id_windfarm" %}
                                    <p class="help-text">{{ form.windfarm.help_text }}</p>
                                </div>
                                <div id="all_turbines_field" class="form-group col-6">
                                    {{ form.all_turbines.label_tag }}<br>
                                    <p class="required">{{ form.all_turbines.errors.as_text }}</p>
                                    {% render_field form.all_turbines class="form-control" id="all_turbines" %}
                                    <p class="help-text">{{ form.all_turbines.help_text }}</p>
                                </div>
                                {% endif %}
                                <div id="turbines_field" class="form-group col-8">
                                    {{ form.turbines.label_tag }}<br>
                                    <p class="required">{{ form.turbines.errors.as_text }}</p>
                                    {% render_field form.turbines class="form-control" %}
                                    <p class="help-text">{{ form.turbines.help_text }}</p>
                                </div>
                                <div id="turbines_field" class="form-group col-4">
                                    {{ form.parkinfo.label_tag }}<br>
                                    <p class="required">{{ form.parkinfo.errors.as_text }}</p>
                                    {% render_field form.parkinfo class="form-control" %}
                                    <p class="help-text">{{ form.parkinfo.help_text }}</p>
                                </div>
                            </div>
                        </div>
                </div>
                <div class="card">
                    <div class="card-header">Customer</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="form-group col-lg-4 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.customer.label_tag }}<br>
                                    <p class="required">{{ form.customer.errors.as_text }}</p>
                                    {% render_field form.customer class="form-control" %}
                                    <p class="help-text">{{ form.customer.help_text }}</p>
                                </div>
                                <div class="form-group col-lg-4 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.customer_contact.label_tag }}<br>
                                    <p class="required">{{ form.customer_contact.errors.as_text }}</p>
                                    {% render_field form.customer_contact class="form-control" %}
                                    <p class="help-text">{{ form.customer_contact.help_text }}</p>
                                </div>
                                <div class="form-group col-lg-4 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.kundendaten.label_tag }}<br>
                                    <p class="required">{{ form.kundendaten.errors.as_text }}</p>
                                    {% render_field form.kundendaten class="form-control" %}
                                    <p class="help-text">{{ form.kundendaten.help_text }}</p>
                                </div>
                            </div>
                        </div>
                </div>
                <div class="card">
                    <div class="card-header">Contract</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="form-group col-lg-2 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.contract.label_tag }}<br>
                                    <p class="required">{{ form.contract.errors.as_text }}</p>
                                    {% render_field form.contract class="form-control" %}
                                    <p class="help-text">{{ form.contract.help_text }}</p>
                                </div>
                                <div class="form-group col-lg-4 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.contract_type.label_tag }}<br>
                                    <p class="required">{{ form.contract_type.errors.as_text }}</p>
                                    {% render_field form.contract_type class="form-control" %}
                                    <p class="help-text">{{ form.contract_type.help_text }}</p>
                                </div>
                                <div class="form-group col-lg-2 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.run_time.label_tag }}<br>
                                    <p class="required">{{ form.run_time.errors.as_text }}</p>
                                    {% render_field form.run_time class="form-control" %}
                                    <p class="help-text">{{ form.run_time.help_text }}</p>
                                </div>
                                <div class="form-group col-lg-2 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.price.label_tag }}<br>
                                    <p class="required">{{ form.price.errors.as_text }}</p>
                                    {% render_field form.price class="form-control" %}
                                    <p class="help-text">{{ form.price.help_text }}</p>
                                </div>
                                <div class="form-group col-lg-2 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.ebt.label_tag }}<br>
                                    <p class="required">{{ form.ebt.errors.as_text }}</p>
                                    {% render_field form.ebt class="form-control" %}
                                    <p class="help-text">{{ form.ebt.help_text }}</p>
                                </div>
                            </div>
                        </div>
                </div>
                <div class="card">
                    <div class="card-header">Timeline</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="form-group col-lg-2 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.request_date.label_tag }}<br>
                                    <p class="required">{{ form.request_date.errors.as_text }}</p>
                                    {% render_field form.request_date class="form-control" %}
                                    <p class="help-text">{{ form.request_date.help_text }}</p>
                                </div>
                                <div class="form-group col-lg-2 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.start_operation.label_tag }}<br>
                                    <p class="required">{{ form.start_operation.errors.as_text }}</p>
                                    {% render_field form.start_operation class="form-control" %}
                                    <p class="help-text">{{ form.start_operation.help_text }}</p>
                                </div>
                                <div id="signature" class="form-group col-lg-2 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.contract_signature.label_tag }}<br>
                                    <p class="required">{{ form.contract_signature.errors.as_text }}</p>
                                    {% render_field form.contract_signature class="form-control" %}
                                    <p class="help-text">{{ form.contract_signature.help_text }}</p>
                                </div>
                                <div id="award_reason" class="form-group col-lg-4 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.awarding_reason.label_tag }}<br>
                                    <p class="required">{{ form.awarding_reason.errors.as_text }}</p>
                                    {% render_field form.awarding_reason class="form-control" %}
                                    <p class="help-text">{{ form.awarding_reason.help_text }}</p>
                                </div>
                            </div>
                        </div>
                </div>
                <div class="card">
                    <div class="card-header">Expert report before operational commencement</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="form-group col-lg-3 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.expert_report.label_tag }}<br>
                                    <p class="required">{{ form.expert_report.errors.as_text }}</p>
                                    {% render_field form.expert_report class="form-control" id="expert_report" %}
                                    <p class="help-text">{{ form.expert_report.help_text }}</p>
                                </div>
                                <div id="zop_field" class="form-group col-lg-3 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.zop.label_tag }}<br>
                                    <p class="required">{{ form.zop.errors.as_text }}</p>
                                    {% render_field form.zop class="form-control" %}
                                    <p class="help-text">{{ form.zop.help_text }}</p>
                                </div>
                                <div id="rotor_field" class="form-group col-lg-3 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.rotor.label_tag }}<br>
                                    <p class="required">{{ form.rotor.errors.as_text }}</p>
                                    {% render_field form.rotor class="form-control" %}
                                    <p class="help-text">{{ form.rotor.help_text }}</p>
                                </div>
                                <div id="gearbox_endoscopy_field" class="form-group col-lg-3 col-md-4 col-sm-6 col-xs-6">
                                    {{ form.gearbox_endoscopy.label_tag }}<br>
                                    <p class="required">{{ form.gearbox_endoscopy.errors.as_text }}</p>
                                    {% render_field form.gearbox_endoscopy class="form-control" %}
                                    <p class="help-text">{{ form.gearbox_endoscopy.help_text }}</p>
                                </div>
                            </div>
                        </div>
                </div>
                <button type="submit" value="Save" class="btn btn-primary  pull-left">
                    <i class="fa fa-upload"></i> Submit
                </button>
            </div>
        </div>
    </form>
</div>

<script type="text/javascript">
    $("#project-name").change(function () {
      var project_name = $(this).val();
      var csrf = $( "[name=csrfmiddlewaretoken]" ).val();
      var view_name = "{{ request.resolver_match.view_name }}";

      $.ajax({
        url: '{% url "projects:validate_project_name" %}',
        type: 'POST',
        data: {
          'project_name': project_name,
          'csrfmiddlewaretoken': csrf,
          'view_name': view_name
        },
        dataType: 'json',
        success: function (data) {
          if (data.view_name === 'projects:new_project') {
              if (data.similar_projects.length <= 5) {
                    $('#similar_projects').html("");
                    data.similar_projects.forEach(function (project) {$('#similar_projects').prepend("<li>"+project.name+": "+ project.customer__name +", "+ project.status +"</li>")});
                    $('#similar_projects').prepend("<p>Similar projects already in database:</p>");
                  } else {
                    $('#similar_projects').html("");
                    $('#similar_projects').prepend("<li>"+data.similar_projects.length+" similar projects</li>");
                    $('#similar_projects').prepend("<p>Similar projects already in database:</p>");
                  }
                  if (data.similar_projects.length === 0) {
                    $('#similar_projects').html("");
                  }
                  if (data.is_taken) {
                    alert("An project with exactly this name already exists.");
                  }
                }
            }
      });
    });

    function generateOfferNumber() {
        var csrf = $("[name=csrfmiddlewaretoken]").val();
        var dwt = $("#offer_number_dwt").val();
        $.ajax({
            url: '{% url "projects:generate_offer_number" %}',
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': csrf,
                'dwt': dwt
            },
            dataType: 'json',
            success: function (data) {
                $('#card-header').html("General<div class='pull-right' style='font-weight:bold; color:red;'>"+data.new_offer_number.number+"</div>");
            }
        });
    };

    var all_turbines_field = $("#all_turbines_field");
    var windfarms = $("#id_windfarm").val();
    if (typeof windfarms != "undefined" && windfarms != null && windfarms.length != null && windfarms.length > 0) {
        all_turbines_field.show();
    } else {
        all_turbines_field.hide();
    };

    $("#id_windfarm").change(function () {
        var all_turbines_field = $("#all_turbines_field");
        var windfarms = $("#id_windfarm").val();
        if (typeof windfarms != "undefined" && windfarms != null && windfarms.length != null && windfarms.length > 0) {
            all_turbines_field.show();
        } else {
            all_turbines_field.hide();
        };
    });

    $("#all_turbines").change(function () {
        var turbines_field = $("#turbines_field");
        if ($("#all_turbines").is(':checked') && $("#id_windfarm").val() != "undefined" && $("#id_windfarm").val().length > 0) {
            turbines_field.hide();
        } else {
            turbines_field.show();
        };
    });

    var award_field = $("#award_reason");
    var signature_field = $("#signature");
    if ($("#status_id").val() === 'Won' || $("#status_id").val() === 'Lost') {
        award_field.show();
        signature_field.show();
    } else {
        award_field.hide();
        signature_field.hide();
    };

    $("#status_id").change(function () {
        if ($(this).val() === 'Won' || $(this).val() === 'Lost') {
            award_field.show();
            signature_field.show();
        } else {
            award_field.hide();
            signature_field.hide();
        }
    });

    var zop_field = $("#zop_field");
    var rotor_field = $("#rotor_field");
    var gearbox_endoscopy_field = $("#gearbox_endoscopy_field");
    if ($("#expert_report").is(':checked')) {
        zop_field.show();
        rotor_field.show();
        gearbox_endoscopy_field.show();
    } else {
        zop_field.hide();
        rotor_field.hide();
        gearbox_endoscopy_field.hide();
    };

    $("#expert_report").change(function () {
        if ($(this).is(':checked')) {
            zop_field.show();
            rotor_field.show();
            gearbox_endoscopy_field.show();
        } else {
            zop_field.hide();
            rotor_field.hide();
            gearbox_endoscopy_field.hide();
        }
    });
  </script>
{% endblock %}