{% extends "polls/base.html" %}
{% load static %}

{% block title %}
    {{ wec_typ.name }}
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <h1>{{ wec_typ.manufacturer }}</h1>
        <h2>{{ wec_typ.name }}</h2>
        {% if perms.projects.has_sales_status %}
        <a class="btn btn-primary pull-right" href="{% url "polls:new_image" wec_typ_id=wec_typ.pk %}"><i class="fa fa-plus"></i> Add Image</a>
        <a class="btn btn-primary pull-right" href="{% url "polls:wec_typ_edit" wec_typ.id  %}" style="margin-right:2px"><i class="fa fa-edit"></i> Edit</a>
        {% endif %}
    </div>
    <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
        <div id="myCarousel" class="carousel slide" data-ride="carousel">
            <ol class="carousel-indicators">
                {% for i in wec_typ.image.all %}
                {% if i.available = True %}
                {% if forloop.counter0 = 0 %}
                    <li data-target="#myCarousel" data-slide-to="{{ forloop.counter0 }}" class="active"></li>
                {% else %}
                    <li data-target="#myCarousel" data-slide-to="{{ forloop.counter0 }}"></li>
                {% endif %}
                {% endif %}
                {% endfor %}
            </ol>
            <div class="carousel-inner" role="listbox">
                {% for i in wec_typ.image.all %}
                {% if i.available = True %}
                {% if forloop.counter0 = 0 %}
                    <div class="carousel-item active">
                {% else %}
                    <div class="carousel-item">
                {% endif %}
                    <img class="d-block img-fluid" src="{{ i.file.url }}" style="width: 100%; height:auto; margin-bottom:10px" alt="image {{ forloop.counter0 }}">
                    <div class="bottom-right">Source: {{ i.source }}</div>
                    </div>
                {% endif %}
                {% endfor %}
            </div>
            <!--<a class="carousel-control-prev" href="#myCarousel" role="button" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#myCarousel" role="button" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
            </a>-->
        </div>
        {% if wec_typ.image.all.0.available = True %}<p>All images are published either under the <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons License</a> or under the <a href="http://opendefinition.org/licenses/gfdl/">GNU Free Documentation License</a>.</p>{% endif %}
        {% if wec_typ.power_curve %}<div id="power_curve" style="width:122%; margin-left:-84px">{{ chart.as_html }}</div>{% endif %}
    </div>
    <div class="col-lg-6 col-lg-6 col-md-6 col-sm-6 col-xs-12">
        <table class="table">
            <colgroup> <col width="80"> <col width="100"> </colgroup>
            <tr>
                <th colspan="2">General</th>
            </tr>
            {% if wec_typ.product_web %}<tr>
                <td>Product details</td>
                <td><a href="{{ wec_typ.product_web }}">{{ wec_typ.manufacturer }} {{ wec_typ.name }}</a></td>
            </tr>{% endif %}
            {% if wec_typ.output_power %}<tr>
                <td>Output power</td>
                <td>{{ wec_typ.output_power }} kW</td>
            </tr>{% endif %}
            {% if wec_typ.nr_blades %}<tr>
                <td>Amount of blades</td>
                <td>{{ wec_typ.nr_blades }}</td>
            </tr>{% endif %}
            {% if wec_typ.rotor_diameter %}<tr>
                <td>Rotor Diameter</td>
                <td>{{ wec_typ.rotor_diameter }} m</td>
            </tr>{% endif %}
            {% if wec_typ.swept_area %}<tr>
                <td>Swept Area</td>
                <td>{{ wec_typ.swept_area }} m²</td>
            </tr>{% endif %}
            {% if wec_typ.power_density %}<tr>
                <td>Power Density</td>
                <td>{{ wec_typ.power_density }} kW/m²</td>
            </tr>{% endif %}
            {% if wec_typ.wind_clas.all.count > 0 %}<tr>
                <td>Wind Class</td>
                <td>
                {% for w in wec_typ.wind_clas.all %}
                    {% if forloop.last %}
                        {{ w.name }}
                    {% else %}
                        {{ w.name }},
                    {% endif %}
                {% endfor %}
                </td>
            </tr>{% endif %}
            {% if wec_typ.year %}<tr>
                <td>First Installation</td>
                <td>{{ wec_typ.year }}</td>
            </tr>{% endif %}
            <tr>
                <td>Offshore</td>
                <td>{{ wec_typ.offshore }}</td>
            </tr>
            <tr>
                <td>Regulation</td>
                <td>{{ wec_typ.reg }}</td>
            </tr>
            <tr>
                <td>Drivetrain</td>
                <td>{{ wec_typ.drive }}</td>
            </tr>
            {% if wec_typ.description %}<tr>
                <th colspan="2">Information</th>
            </tr>
            <tr>
                <td colspan="2">{{ wec_typ.description|linebreaks }}</td>
            </tr>{% endif %}
            {% if wec.typ.min_rot_speed_r_m or wec_typ.max_rot_speed_r_m or wec_typ.cut_in or wec_typ.nominal_speed or wec_typ.cut_out %}<tr>
                <th colspan="2">Technical</th>
            </tr>{% endif %}
            {% if wec_typ.min_rot_speed_r_m %}<tr>
                <td>Min. Rotational Speed</td>
                <td>{{ wec_typ.min_rot_speed_r_m }} R/m</td>
            </tr>{% endif %}
            {% if wec_typ.max_rot_speed_r_m %}<tr>
                <td>Max. Rotational Speed</td>
                <td>{{ wec_typ.max_rot_speed_r_m }} R/m</td>
            </tr>{% endif %}
            {% if wec_typ.cut_in %}<tr>
                <td>Cut-in Wind Speed</td>
                <td>{{ wec_typ.cut_in }} m/s</td>
            </tr>{% endif %}
            {% if wec_typ.nominal_speed %}<tr>
                <td>Nominal Wind Speed</td>
                <td>{{ wec_typ.nominal_speed }} m/s</td>
            </tr>{% endif %}
            {% if wec_typ.cut_out %}<tr>
                <td>Cut-out Wind Speed</td>
                <td>{{ wec_typ.cut_out }} m/s</td>
            </tr>{% endif %}
            {% if wec_typ.tot_weight_t or wec_typ.tower_weight_t or wec_typ.hub_weight_t or wec_typ.rotor_weight_t%}<tr>
                <th colspan="2">Weights</th>
            </tr>{% endif %}
            {% if wec_typ.tot_weight_t %}<tr>
                <td>Total Weight</td>
                <td>{{ wec_typ.tot_weight_t }} t</td>
            </tr>{% endif %}
            {% if wec_typ.tower_weight_t %}<tr>
                <td>Tower Weight</td>
                <td>{{ wec_typ.tower_weight_t }} t</td>
            </tr>{% endif %}
            {% if wec_typ.hub_weight_t %}<tr>
                <td>Hub Weight</td>
                <td>{{ wec_typ.hub_weight_t }} t</td>
            </tr>{% endif %}
            {% if wec_typ.rotor_weight_t %}<tr>
                <td>Rotor Weight</td>
                <td>{{ wec_typ.rotor_weight_t }} t</td>
            </tr>{% endif %}
            <tr>
                <th colspan="2">Heights</th>
            </tr>
            {% if wec_typ.min_hub_height or wec_typ.max_hub_height %}
            <tr>
                <td>Hub Heights</td>
                <td>{% if wec_typ.min_hub_height %}{{ wec_typ.min_hub_height }} m - {% else %} {% endif %}{% if wec_typ.max_hub_height %}{{ wec_typ.max_hub_height }} m{% else %} {% endif %}</td>
            </tr>
            {% endif %}
            {% if wec_typ.sound_level %}
            <tr>
                <td>Sound Level</td>
                <td>{{ wec_typ.sound_level }} dB</td>
            </tr>
            {% endif %}
        </table>
    </div>
    <div class="col-12">
        {% if turbines_count > 0 %}
        <table class="table">
            <tr>
                <th colspan="9">Amount of turbines in Databse (displayed on map)</th>
                <td>{{ turbines_count }}</td>
            </tr>
            <tr class="table-row-header">
                <th colspan="9">Contracted turbines</th>
                <td>{{ wec_typ.turbine_of_type_under_contract|length }} <i class="fa fa-plus pull-right"></i></td>
            </tr>
            {% for t, link in wec_typ.turbine_of_type_under_contract.items %}
                {% if forloop.counter0|divisibleby:10 %}
                <tr class="collapse-row">
                {% endif %}
                    <td><a href="{{ link }}">{{ t }}</a></td>
                {% if forloop.counter|divisibleby:10 or forloop.last %}
                </tr>
                {% endif %}
            {% endfor %}
            </tr>
        </table>
        {% endif %}
    </div>
    <div class="container" id="map" style="width: 100%; height: 600px;"></div>
    </div>
    <div class="col-12">
        <table class="table">
            {% if wec_typ.comment.all|length > 0 %}
            <tr class="table-row-header">
                <th colspan="3">Change history <i class="fa fa-plus pull-right"></i></th>
            </tr>
            {% for ch in wec_typ.comment.all %}
            <tr class="collapse-row">
                <td>{{ ch.created }}</td>
                <td>by {{ ch.created_by }}</td>
                <td>{{ ch.text }}</td>
            </tr>
            {% endfor %}
            <tr class="table-row-header"></tr>
            {% endif %}
        </table>
    </div>
</div>
<script>
    function initMap() {
        var turbines = {{json|safe}}
        var infowindows = null;

        var locations = [];
        for (i = 0; i < turbines.length; i++) {
                var url_parts = ["<b><a href=/turbine/", turbines[i]["pk"], "/", turbines[i]["slug"], "/>", turbines[i]["turbine_id"], "</a><br>"];
                var url = url_parts.join("");
                locations.push([new google.maps.LatLng(turbines[i]["latitude"], turbines[i]["longitude"]), url, '/media/wind_turbine.png'])
            };

        infowindow = new google.maps.InfoWindow({
            content: "holding..."
        });

        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 5,
          center: {lat: 52.071876, lng: 8.441456}
        });

        var markers = locations.map(function(location, i) {
            return new google.maps.Marker({
                position: location[0],
                title: location[1],
                icon: location[2]
            });
        });

        for (var i=0; i< markers.length; i++) {
            var marker = markers[i];
            google.maps.event.addListener(marker, 'click', function() {
                infowindow.setContent(this.title);
                infowindow.open(map, this);
            });}

        var markerCluster = new MarkerClusterer(map, markers, {styles: [
        {
            textColor: 'white',
            url: '/static/img/m/m1.png',
            height: 52,
            width: 53
        },
        {
            textColor: 'white',
            url: '/static/img/m/m2.png',
            height: 55,
            width: 56
        },
        {
            textColor: 'white',
            url: '/static/img/m/m3.png',
            height: 65,
            width: 66
        },
        {
            textColor: 'white',
            url: '/static/img/m/m4.png',
            height: 77,
            width: 78
        },
        {
            textColor: 'white',
            url: '/static/img/m/m5.png',
            height: 89,
            width: 90
        }
    ]
        });
    }

    $('.table-row-header').click(function(){
        $(this).nextUntil('.table-row-header').css('display', function(i,v){
            return this.style.display === 'table-row' ? 'none' : 'table-row';
        });
    });
    </script>
    <script src="/static/js/markerclusterer.js"></script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBPf2vVr8toXpXJ2TLInDRjWS4cLQ5tzAk&callback=initMap">
    </script>
{% endblock %}
